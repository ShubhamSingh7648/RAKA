<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anon Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    'use strict';

    /* â”€â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:          #0d0f14;
      --surface:     #13161e;
      --surface2:    #1a1e2a;
      --surface3:    #222736;
      --border:      #2a2f40;
      --accent:      #7c6aff;
      --accent-dim:  #4a3fb5;
      --accent-glow: rgba(124,106,255,0.18);
      --green:       #3de0a0;
      --red:         #ff5f6d;
      --text:        #e8eaf0;
      --text-muted:  #626880;
      --text-dim:    #8b92b0;
      --own-bubble:  #2c2460;
      --own-border:  #4a3fb5;
      --msg-radius:  18px;
      --font-ui:     'Syne', sans-serif;
      --font-body:   'DM Sans', sans-serif;
      --font-mono:   'DM Mono', monospace;
      --transition:  0.22s cubic-bezier(0.4,0,0.2,1);
    }

    html, body {
      height: 100%;
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€â”€ Background texture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 80% 60% at 20% 0%, rgba(124,106,255,0.06) 0%, transparent 60%),
        radial-gradient(ellipse 60% 50% at 80% 100%, rgba(61,224,160,0.04) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    /* â”€â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      height: 100dvh;
      max-width: 780px;
      margin: 0 auto;
    }

    /* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: rgba(13,15,20,0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      flex-shrink: 0;
    }

    #header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #logo {
      font-family: var(--font-ui);
      font-weight: 700;
      font-size: 20px;
      letter-spacing: -0.5px;
      color: var(--text);
    }

    #logo span {
      color: var(--accent);
    }

    #online-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-dim);
      background: var(--surface2);
      border: 1px solid var(--border);
      padding: 4px 10px;
      border-radius: 99px;
    }

    #online-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 6px var(--green);
      animation: pulse-dot 2s infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* â”€â”€â”€ Status Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #status-bar {
      padding: 8px 20px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      min-height: 38px;
    }

    #status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: background var(--transition), box-shadow var(--transition);
      flex-shrink: 0;
    }

    #status-indicator.searching {
      background: #f5a623;
      box-shadow: 0 0 8px #f5a623;
      animation: spin-pulse 1.2s ease-in-out infinite;
    }

    #status-indicator.matched {
      background: var(--green);
      box-shadow: 0 0 8px var(--green);
    }

    #status-indicator.disconnected {
      background: var(--red);
      box-shadow: 0 0 8px var(--red);
    }

    @keyframes spin-pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.4); opacity: 0.6; }
    }

    #status-text {
      font-size: 13px;
      font-family: var(--font-body);
      font-weight: 400;
      color: var(--text-dim);
      transition: color var(--transition);
    }

    #status-text.matched { color: var(--green); }
    #status-text.searching { color: #f5a623; }
    #status-text.disconnected { color: var(--red); }

    #skip-hint {
      margin-left: auto;
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-muted);
      background: var(--surface2);
      border: 1px solid var(--border);
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }

    /* â”€â”€â”€ Messages Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #messages-wrap {
      flex: 1;
      overflow-y: auto;
      padding: 20px 20px 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      scroll-behavior: smooth;
    }

    #messages-wrap::-webkit-scrollbar { width: 4px; }
    #messages-wrap::-webkit-scrollbar-track { background: transparent; }
    #messages-wrap::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* Empty State */
    #empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--text-muted);
      font-size: 14px;
      text-align: center;
      padding: 40px 20px;
      user-select: none;
    }

    #empty-state .empty-icon {
      font-size: 40px;
      opacity: 0.5;
    }

    #empty-state .empty-title {
      font-family: var(--font-ui);
      font-size: 18px;
      font-weight: 600;
      color: var(--text-dim);
    }

    #empty-state .empty-sub {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.6;
      max-width: 280px;
    }

    .hint-keys {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .kbd {
      font-family: var(--font-mono);
      font-size: 11px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 2px 7px;
      color: var(--text-dim);
    }

    /* â”€â”€â”€ Message Bubbles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .msg-row {
      display: flex;
      flex-direction: column;
      max-width: 72%;
      animation: fadeSlideIn 0.25s ease-out;
    }

    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .msg-row.own { align-self: flex-end; align-items: flex-end; }
    .msg-row.stranger { align-self: flex-start; align-items: flex-start; }

    .msg-label {
      font-size: 10px;
      font-family: var(--font-mono);
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .msg-row.own .msg-label { color: rgba(124,106,255,0.6); }

    .bubble {
      padding: 10px 14px;
      border-radius: var(--msg-radius);
      font-size: 14px;
      line-height: 1.55;
      font-weight: 300;
      word-break: break-word;
    }

    .msg-row.own .bubble {
      background: var(--own-bubble);
      border: 1px solid var(--own-border);
      border-bottom-right-radius: 4px;
      color: #d0ccff;
    }

    .msg-row.stranger .bubble {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
      color: var(--text);
    }

    .msg-time {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    /* System messages */
    .sys-msg {
      align-self: center;
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-muted);
      background: var(--surface2);
      border: 1px solid var(--border);
      padding: 4px 12px;
      border-radius: 99px;
      margin: 8px 0;
      animation: fadeSlideIn 0.2s ease-out;
    }

    /* â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast-container {
      position: fixed;
      top: 70px;
      right: 20px;
      z-index: 999;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }

    .toast {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-left: 3px solid var(--red);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 13px;
      color: var(--text);
      max-width: 280px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      animation: toastIn 0.25s ease-out;
      pointer-events: all;
    }

    .toast.info { border-left-color: var(--accent); }
    .toast.success { border-left-color: var(--green); }

    @keyframes toastIn {
      from { opacity: 0; transform: translateX(20px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    @keyframes toastOut {
      from { opacity: 1; transform: translateX(0); }
      to   { opacity: 0; transform: translateX(20px); }
    }

    /* â”€â”€â”€ Cooldown Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #cooldown-bar {
      height: 2px;
      background: var(--surface3);
      position: relative;
      overflow: hidden;
      display: none;
    }

    #cooldown-fill {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.5s linear;
    }

    /* â”€â”€â”€ Input Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #input-area {
      padding: 14px 20px 18px;
      border-top: 1px solid var(--border);
      background: rgba(13,15,20,0.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      flex-shrink: 0;
    }

    #input-row {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 8px 8px 8px 16px;
      transition: border-color var(--transition), box-shadow var(--transition);
    }

    #input-row:focus-within {
      border-color: var(--accent-dim);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    #input-row.disabled {
      opacity: 0.45;
      pointer-events: none;
    }

    #msg-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-family: var(--font-body);
      font-size: 14px;
      font-weight: 300;
      line-height: 1.5;
      resize: none;
      max-height: 120px;
      min-height: 24px;
      height: 24px;
      overflow-y: auto;
    }

    #msg-input::placeholder { color: var(--text-muted); }
    #msg-input::-webkit-scrollbar { width: 3px; }
    #msg-input::-webkit-scrollbar-thumb { background: var(--border); }

    #send-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background var(--transition), transform var(--transition), opacity var(--transition);
    }

    #send-btn:hover { background: #9182ff; }
    #send-btn:active { transform: scale(0.92); }
    #send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    #send-btn svg { width: 16px; height: 16px; fill: currentColor; }

    #action-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      gap: 8px;
    }

    #skip-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: var(--font-body);
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 12px;
      cursor: pointer;
      transition: color var(--transition), border-color var(--transition), background var(--transition);
    }

    #skip-btn:hover { color: var(--red); border-color: var(--red); background: rgba(255,95,109,0.07); }
    #skip-btn:disabled { opacity: 0.35; cursor: not-allowed; }

    #find-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: var(--font-body);
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 12px;
      cursor: pointer;
      transition: color var(--transition), border-color var(--transition), background var(--transition);
    }

    #find-btn:hover { color: var(--green); border-color: var(--green); background: rgba(61,224,160,0.07); }

    #char-info {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
      margin-left: auto;
    }

    /* â”€â”€â”€ Swipe Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #swipe-indicator {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: rgba(255,95,109,0.12);
      border: 1px solid rgba(255,95,109,0.3);
      color: var(--red);
      padding: 8px 16px;
      border-radius: 99px;
      font-size: 12px;
      font-family: var(--font-mono);
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
      z-index: 50;
    }

    #swipe-indicator.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 600px) {
      #header { padding: 12px 16px; }
      #messages-wrap { padding: 16px 14px 8px; }
      #input-area { padding: 10px 14px 14px; }
      .msg-row { max-width: 85%; }
      #skip-hint { display: none; }
      #logo { font-size: 18px; }
    }
  </style>
</head>
<body>

<div id="app">
  <!-- Header -->
  <div id="header">
    <div id="header-left">
      <div id="logo">anon<span>.</span>chat</div>
      <!-- Username chip (visible when logged in) -->
      <div id="user-chip" style="
        display:none;align-items:center;gap:6px;
        margin-left:10px;
        font-family:var(--font-mono);font-size:12px;
        background:var(--surface2);border:1px solid var(--accent-dim);
        color:var(--accent);padding:3px 10px;border-radius:99px;
      ">
        <span style="width:6px;height:6px;border-radius:50%;background:var(--accent);display:inline-block;flex-shrink:0;"></span>
        <span id="user-chip-name"></span>
      </div>
       <button id="login-btn" style="
    margin-left:12px;
    font-size:12px;
    padding:4px 10px;
    border-radius:6px;
    border:1px solid var(--border);
    background:var(--surface2);
    color:var(--text-muted);
    cursor:pointer;
  ">
    Login
  </button>
    </div>
    <div id="online-badge">
      <div id="online-dot"></div>
      <span id="online-count">â€” online</span>
    </div>
  </div>

  <!-- Status Bar -->
  <div id="status-bar">
    <div id="status-indicator"></div>
    <span id="status-text">Connectingâ€¦</span>
    <span id="skip-hint">Shift+Enter to skip</span>
  </div>

  <!-- Cooldown Progress -->
  <div id="cooldown-bar">
    <div id="cooldown-fill"></div>
  </div>

  <!-- Messages -->
  <div id="messages-wrap" role="log" aria-live="polite">
    <div id="empty-state">
      <div class="empty-icon">ðŸ‘¤</div>
      <div class="empty-title">Find a stranger</div>
      <div class="empty-sub">Connect anonymously with someone new. Your identity stays hidden.</div>
      <div class="hint-keys">
        <span class="kbd">Enter</span> send
        <span class="kbd">Shift+Enter</span> skip
        <span class="kbd">â†‘ swipe</span> skip on mobile
      </div>
    </div>
  </div>

  <!-- Input Area -->
  <div id="input-area">
    <div id="input-row" class="disabled">
      <textarea
        id="msg-input"
        placeholder="Say somethingâ€¦"
        rows="1"
        autocomplete="off"
        spellcheck="true"
        aria-label="Message input"
      ></textarea>
      <button id="send-btn" aria-label="Send message" disabled>
        <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
      </button>
    </div>
    <div id="action-row">
      <button id="find-btn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        Find Match
      </button>
      <button id="skip-btn" disabled>
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="5 12 19 12"/><polyline points="12 5 19 12 12 19"/></svg>
        Skip
      </button>
      <!-- Friend Request: visible only when logged in + matched -->
      <button id="friend-req-btn" style="
        display:none;align-items:center;gap:5px;
        font-family:var(--font-body);font-size:12px;font-weight:500;
        color:var(--green);background:rgba(61,224,160,0.08);
        border:1px solid rgba(61,224,160,0.3);border-radius:8px;
        padding:6px 12px;cursor:pointer;
        transition:background 0.2s,border-color 0.2s;
      ">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
        Add Friend
      </button>
      <span id="char-info"></span>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toast-container" aria-live="assertive"></div>

<!-- Swipe Indicator -->
<div id="swipe-indicator">â†‘ Release to skip</div>

<div id="auth-modal" style="
  position:fixed;inset:0;
  background:rgba(0,0,0,0.65);
  display:none;align-items:center;justify-content:center;
  z-index:9999;backdrop-filter:blur(4px);
">
  <div style="
    background:var(--surface2);border:1px solid var(--border);
    border-radius:16px;width:300px;
    display:flex;flex-direction:column;overflow:hidden;
    box-shadow:0 24px 64px rgba(0,0,0,0.5);
  ">
    <!-- Tab row -->
    <div style="display:flex;border-bottom:1px solid var(--border);">
      <button id="tab-login" onclick="switchAuthTab('login')" style="
        flex:1;padding:12px;background:var(--surface3);border:none;
        color:var(--text);font-family:var(--font-ui);font-size:13px;
        font-weight:600;cursor:pointer;transition:background 0.2s;
      ">Login</button>
      <button id="tab-signup" onclick="switchAuthTab('signup')" style="
        flex:1;padding:12px;background:transparent;border:none;
        color:var(--text-muted);font-family:var(--font-ui);font-size:13px;
        font-weight:600;cursor:pointer;transition:background 0.2s;
      ">Sign Up</button>
    </div>
    <!-- Fields -->
    <div style="display:flex;flex-direction:column;gap:10px;padding:20px;">
      <div id="signup-username-wrap" style="display:none;">
        <input id="auth-username" placeholder="Username" style="
          width:100%;padding:9px 12px;border-radius:8px;
          border:1px solid var(--border);background:var(--surface3);
          color:var(--text);font-size:13px;outline:none;
          font-family:var(--font-body);
        ">
      </div>
      <input id="auth-email" placeholder="Email" style="
        padding:9px 12px;border-radius:8px;
        border:1px solid var(--border);background:var(--surface3);
        color:var(--text);font-size:13px;outline:none;
        font-family:var(--font-body);
      ">
      <input id="auth-password" type="password" placeholder="Password" style="
        padding:9px 12px;border-radius:8px;
        border:1px solid var(--border);background:var(--surface3);
        color:var(--text);font-size:13px;outline:none;
        font-family:var(--font-body);
      ">
      <button id="auth-submit" style="
        padding:10px;border:none;border-radius:8px;
        background:var(--accent);color:white;cursor:pointer;
        font-family:var(--font-ui);font-size:13px;font-weight:600;
        transition:background 0.2s;
      ">Login</button>
      <button onclick="document.getElementById('auth-modal').style.display='none'" style="
        padding:6px;border:none;background:transparent;
        color:var(--text-muted);font-size:12px;cursor:pointer;
        font-family:var(--font-body);
      ">Cancel</button>
    </div>
  </div>
</div>

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 1 â€” DOM REFERENCES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DOM = {
  messagesWrap:   document.getElementById('messages-wrap'),
  emptyState:     document.getElementById('empty-state'),
  statusIndicator:document.getElementById('status-indicator'),
  statusText:     document.getElementById('status-text'),
  onlineCount:    document.getElementById('online-count'),
  msgInput:       document.getElementById('msg-input'),
  sendBtn:        document.getElementById('send-btn'),
  inputRow:       document.getElementById('input-row'),
  skipBtn:        document.getElementById('skip-btn'),
  findBtn:        document.getElementById('find-btn'),
  charInfo:       document.getElementById('char-info'),
  cooldownBar:    document.getElementById('cooldown-bar'),
  cooldownFill:   document.getElementById('cooldown-fill'),
  swipeIndicator: document.getElementById('swipe-indicator'),
  toastContainer: document.getElementById('toast-container'),
  loginBtn:       document.getElementById('login-btn'),
  friendReqBtn:   document.getElementById('friend-req-btn'),
  userChip:       document.getElementById('user-chip'),
  userChipName:   document.getElementById('user-chip-name'),
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 2 â€” STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const state = {
  matched:        false,
  roomId:         null,
  skipCooldown:   false,
  cooldownTimer:  null,
  loggedIn:       false,
  username:       null,
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 3 â€” SOCKET SETUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const socket = io('http://localhost:3001/chat', {
  transports: ['websocket'],
  reconnectionDelay: 1000,
  reconnectionAttempts: Infinity,
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 4 â€” UI STATE MANAGER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const UI = {
  setStatus(mode, text) {
    const { statusIndicator, statusText } = DOM;
    statusIndicator.className = mode;
    statusText.className = mode;
    statusText.textContent = text;
  },

  setMatched(isMatched) {
    state.matched = isMatched;
    DOM.inputRow.classList.toggle('disabled', !isMatched);
    DOM.sendBtn.disabled   = !isMatched;
    DOM.skipBtn.disabled   = !isMatched;
    // Friend request button: only when logged in AND matched
    const showFriendBtn = isMatched && state.loggedIn;
    DOM.friendReqBtn.style.display = showFriendBtn ? 'flex' : 'none';
    if (isMatched) {
      DOM.msgInput.focus();
    }
  },

  clearMessages() {
    // Remove all children except empty-state
    const wrap = DOM.messagesWrap;
    while (wrap.firstChild) wrap.removeChild(wrap.firstChild);
    wrap.appendChild(DOM.emptyState);
    DOM.emptyState.style.display = 'flex';
  },

  hideEmpty() {
    DOM.emptyState.style.display = 'none';
  },

  scrollToBottom() {
    DOM.messagesWrap.scrollTop = DOM.messagesWrap.scrollHeight;
  },

  appendMessage({ sender, message, timestamp, isOwn }) {
    UI.hideEmpty();
    const row = document.createElement('div');
    row.className = `msg-row ${isOwn ? 'own' : 'stranger'}`;

    const label = document.createElement('div');
    label.className = 'msg-label';
    label.textContent = isOwn ? 'You' : 'Stranger';

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = message;

    const time = document.createElement('div');
    time.className = 'msg-time';
    time.textContent = formatTime(timestamp || Date.now());

    row.appendChild(label);
    row.appendChild(bubble);
    row.appendChild(time);
    DOM.messagesWrap.appendChild(row);
    UI.scrollToBottom();
  },

  appendSystemMsg(text) {
    UI.hideEmpty();
    const el = document.createElement('div');
    el.className = 'sys-msg';
    el.textContent = text;
    DOM.messagesWrap.appendChild(el);
    UI.scrollToBottom();
  },

  startCooldown(remainingMs) {
    DOM.cooldownBar.style.display = 'block';
    DOM.cooldownFill.style.width = '100%';
    const duration = remainingMs;
    const start = Date.now();

    const tick = () => {
      const elapsed = Date.now() - start;
      const pct = Math.max(0, 100 - (elapsed / duration) * 100);
      DOM.cooldownFill.style.width = pct + '%';
      if (pct > 0) {
        state.cooldownTimer = requestAnimationFrame(tick);
      } else {
        DOM.cooldownBar.style.display = 'none';
        state.skipCooldown = false;
      }
    };
    state.cooldownTimer = requestAnimationFrame(tick);
    state.skipCooldown = true;
  },
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 5 â€” TOAST SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showToast(message, type = 'error', duration = 3500) {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  DOM.toastContainer.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = 'toastOut 0.25s ease-in forwards';
    setTimeout(() => toast.remove(), 260);
  }, duration);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 6 â€” HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function formatTime(ts) {
  const d = new Date(ts);
  return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 7 â€” ACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function findMatch() {
  UI.setStatus('searching', 'Searching for a strangerâ€¦');
  socket.emit('find_match');
  UI.setMatched(false);
}

function sendMessage() {
  const text = DOM.msgInput.value.trim();
  if (!text || !state.matched) return;
  socket.emit('message', text);
  // Optimistically display own message
  UI.appendMessage({ sender: socket.id, message: text, timestamp: Date.now(), isOwn: true });
  DOM.msgInput.value = '';
  DOM.msgInput.style.height = '24px';
  DOM.charInfo.textContent = '';
}

function skipChat() {
  if (state.skipCooldown) return;
  resetFriendBtn();
  socket.emit('skip');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 8 â€” SOCKET EVENT HANDLERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
socket.on('connect', () => {
  UI.setStatus('searching', 'Connected â€” finding a matchâ€¦');
  socket.emit('find_match');
});

socket.on('disconnect', () => {
  UI.setStatus('disconnected', 'Disconnected. Reconnectingâ€¦');
  UI.setMatched(false);
  state.matched = false;
});

socket.on('reconnect', () => {
  UI.setStatus('searching', 'Reconnected â€” finding a matchâ€¦');
  socket.emit('find_match');
});

socket.on('matched', ({ roomId }) => {
  state.roomId = roomId;
  UI.clearMessages();
  UI.setStatus('matched', 'Connected with a stranger');
  UI.setMatched(true);
  UI.appendSystemMsg('âœ¦ You are now chatting with a stranger');
  showToast('Matched! Say hi ðŸ‘‹', 'success', 2500);
});

socket.on('message', ({ sender, message, timestamp }) => {
  // Skip if it's our own message (already shown optimistically)
  if (sender === socket.id) return;
  UI.appendMessage({ sender, message, timestamp, isOwn: false });
});

socket.on('partner_skipped', () => {
  UI.setMatched(false);
  resetFriendBtn();
  UI.appendSystemMsg('âŸ¶ Stranger skipped. Finding a new matchâ€¦');
  UI.setStatus('searching', 'Searching for a strangerâ€¦');
  setTimeout(() => {
    UI.clearMessages();
    socket.emit('find_match');
  }, 1200);
});

socket.on('partner_disconnected', () => {
  UI.setMatched(false);
  resetFriendBtn();
  UI.appendSystemMsg('âŠ˜ Stranger disconnected. Finding a new matchâ€¦');
  UI.setStatus('searching', 'Searching for a strangerâ€¦');
  setTimeout(() => {
    UI.clearMessages();
    socket.emit('find_match');
  }, 1200);
});

socket.on('skip_cooldown', ({ remaining }) => {
  showToast(`Skip cooldown: wait ${Math.ceil(remaining / 1000)}s`, 'error', remaining);
  UI.startCooldown(remaining);
});

socket.on('rate_limited', ({ message }) => {
  showToast(message, 'error');
});

socket.on('message_error', ({ message }) => {
  showToast(message, 'error');
});

socket.on('online_count', ({ count }) => {
  DOM.onlineCount.textContent = `${count.toLocaleString()} online`;
});

function handleSocketErrorToast(err, fallbackMessage) {
  const message = err?.message || fallbackMessage;
  const code = err?.code ? ` [${err.code}]` : '';
  const retryHint = err?.retryable ? ' Try again.' : '';
  const isConflict = err?.code === 'CONFLICT';
  showToast(
    `${message}${code}${retryHint}`,
    isConflict ? 'success' : 'error'
  );
  console.error('SocketError', err);
}

socket.on('server_error', (err) => {
  handleSocketErrorToast(err, 'Server error');
});

socket.on('friend_error', (err) => {
  handleSocketErrorToast(err, 'Friend action failed');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 9 â€” KEYBOARD & INPUT EVENT HANDLERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
DOM.msgInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && e.shiftKey) {
    e.preventDefault();
    skipChat();
    return;
  }
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Auto-resize textarea
DOM.msgInput.addEventListener('input', () => {
  DOM.msgInput.style.height = '24px';
  DOM.msgInput.style.height = Math.min(DOM.msgInput.scrollHeight, 120) + 'px';

  const words = DOM.msgInput.value.trim().split(/\s+/).filter(Boolean).length;
  DOM.charInfo.textContent = words > 0 ? `${words}/30 words` : '';
});

DOM.sendBtn.addEventListener('click', sendMessage);
DOM.skipBtn.addEventListener('click', skipChat);
DOM.findBtn.addEventListener('click', findMatch);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 10 â€” GESTURE DETECTION (Mobile Swipe)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const gesture = {
  startY: null,
  startX: null,
  threshold: 100,
};

document.addEventListener('touchstart', (e) => {
  gesture.startY = e.touches[0].clientY;
  gesture.startX = e.touches[0].clientX;
}, { passive: true });

document.addEventListener('touchmove', (e) => {
  if (gesture.startY === null) return;
  const deltaY = gesture.startY - e.touches[0].clientY;
  const deltaX = Math.abs(gesture.startX - e.touches[0].clientX);

  // Only vertical swipes (not horizontal scrolling)
  if (deltaX > 30) return;

  if (deltaY > 60) {
    DOM.swipeIndicator.classList.add('show');
  } else {
    DOM.swipeIndicator.classList.remove('show');
  }
}, { passive: true });

document.addEventListener('touchend', (e) => {
  if (gesture.startY === null) return;
  const deltaY = gesture.startY - e.changedTouches[0].clientY;
  const deltaX = Math.abs(gesture.startX - e.changedTouches[0].clientX);

  DOM.swipeIndicator.classList.remove('show');

  if (deltaX < 30 && deltaY > gesture.threshold && state.matched) {
    skipChat();
  }

  gesture.startY = null;
  gesture.startX = null;
}, { passive: true });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 11 â€” INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function init() {
  UI.setStatus('', 'Connectingâ€¦');
  UI.setMatched(false);
})();
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 11 â€” AUTH + FRIEND REQUEST LOGIC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Auth tab switcher â”€â”€ */
let currentAuthTab = 'login';

function switchAuthTab(tab) {
  currentAuthTab = tab;
  const isSignup = tab === 'signup';
  document.getElementById('signup-username-wrap').style.display = isSignup ? 'block' : 'none';
  document.getElementById('auth-submit').textContent = isSignup ? 'Sign Up' : 'Login';
  document.getElementById('tab-login').style.background  = isSignup ? 'transparent' : 'var(--surface3)';
  document.getElementById('tab-login').style.color       = isSignup ? 'var(--text-muted)' : 'var(--text)';
  document.getElementById('tab-signup').style.background = isSignup ? 'var(--surface3)' : 'transparent';
  document.getElementById('tab-signup').style.color      = isSignup ? 'var(--text)' : 'var(--text-muted)';
}

/* â”€â”€ Open modal â”€â”€ */
DOM.loginBtn.addEventListener('click', () => {
  document.getElementById('auth-modal').style.display = 'flex';
});

/* â”€â”€ Submit handler (login OR signup) â”€â”€ */
document.getElementById('auth-submit').addEventListener('click', async () => {
  const email    = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value.trim();
  const username = document.getElementById('auth-username').value.trim();

  if (!email || !password) return;
  if (currentAuthTab === 'signup' && !username) {
    showToast('Username is required', 'error');
    return;
  }

  const isSignup = currentAuthTab === 'signup';
  const endpoint = isSignup
    ? 'http://localhost:3001/api/v1/auth/register'
    : 'http://localhost:3001/api/v1/auth/login';

  const body = isSignup
    ? { email, password, username }
    : { email, password };

  try {
    const res  = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await res.json();

    if (!res.ok) {
      showToast(data.message || (isSignup ? 'Sign up failed' : 'Login failed'), 'error');
      return;
    }

    const token      = data.data.accessToken;
    const resolvedUsername = data.data.user?.username || username || email.split('@')[0];

    localStorage.setItem('jwt', token);
    socket.emit('upgrade_identity', token);

    // Update UI
    state.loggedIn = true;
    state.username = resolvedUsername;
    DOM.loginBtn.style.display     = 'none';
    DOM.userChip.style.display     = 'flex';
    DOM.userChipName.textContent   = resolvedUsername;

    // Show friend button if already matched
    if (state.matched) {
      DOM.friendReqBtn.style.display = 'flex';
    }

    document.getElementById('auth-modal').style.display = 'none';
    showToast(isSignup ? `Welcome, ${resolvedUsername}! ðŸŽ‰` : 'Logged in âœ“', 'success');

  } catch {
    showToast('Server error', 'error');
  }
});

/* â”€â”€ Socket: identity upgrade confirmation â”€â”€ */
socket.on('identity_upgraded', ({ success, message }) => {
  if (success) showToast('Identity upgraded âœ“', 'success');
  else showToast(message || 'Token upgrade failed', 'error');
});

/* â”€â”€ Friend Request: send â”€â”€ */
DOM.friendReqBtn.addEventListener('click', () => {
  if (!state.matched || !state.loggedIn) return;
  socket.emit('send_friend_request');
  DOM.friendReqBtn.disabled = true;
  DOM.friendReqBtn.textContent = 'Request Sentâ€¦';
  DOM.friendReqBtn.style.color = 'var(--text-muted)';
  DOM.friendReqBtn.style.borderColor = 'var(--border)';
});

/* Friend Request: incoming */
function acceptRequest(requestId, btn) {
  if (!requestId || !btn) return;
  if (btn.dataset.loading === '1') return;

  btn.dataset.loading = '1';
  btn.disabled = true;
  btn.textContent = 'Accepting...';
  socket.emit('accept_friend_request', requestId);
}

socket.on('friend_request_message', (data) => {
  UI.hideEmpty();

  const currentUsername = state.username || DOM.userChipName.textContent || '';
  const isOwn = data?.from?.username === currentUsername;

  const msg = document.createElement('div');
  msg.className = 'sys-msg';
  if (data?.requestId) {
    msg.dataset.requestId = data.requestId;
  }

  if (isOwn) {
    msg.textContent = 'You sent a friend request.';
  } else {
    msg.innerHTML = `
      <b>${data?.from?.username || 'Stranger'}</b> sent a friend request.
      <button onclick="acceptRequest('${data?.requestId || ''}', this)">
        Accept
      </button>
    `;
  }

  DOM.messagesWrap.appendChild(msg);
  UI.scrollToBottom();
});

/* â”€â”€ Friend Request: accepted by the other side â”€â”€ */
socket.on('friend_request_accepted', ({ username }) => {
  document
    .querySelectorAll('[data-request-id]')
    .forEach((el) => el.remove());

  // Disable the Add Friend button so it can't be sent again
  DOM.friendReqBtn.style.display = 'none';

  // Show a private space message in chat
  UI.hideEmpty();
  const el = document.createElement('div');
  el.style.cssText = `
    align-self:center;text-align:center;
    background:linear-gradient(135deg,rgba(124,106,255,0.12),rgba(61,224,160,0.08));
    border:1px solid rgba(124,106,255,0.3);border-radius:14px;
    padding:16px 20px;margin:12px auto;max-width:340px;
    animation:fadeSlideIn 0.3s ease-out;font-family:var(--font-body);
  `;
  el.innerHTML = `
    <div style="font-size:20px;margin-bottom:6px;">ðŸ”’</div>
    <div style="font-size:13px;font-weight:600;color:var(--accent);margin-bottom:4px;">
      ${username || 'Your stranger'} accepted your friend request!
    </div>
    <div style="font-size:12px;color:var(--text-muted);line-height:1.5;">
      You now share a private space. Your usernames have been exchanged.
    </div>
  `;
  DOM.messagesWrap.appendChild(el);
  UI.scrollToBottom();
  showToast(`${username || 'Stranger'} accepted! ðŸŽ‰`, 'success', 4000);
});

/* â”€â”€ On skip/disconnect reset friend button state â”€â”€ */
function resetFriendBtn() {
  DOM.friendReqBtn.disabled = false;
  DOM.friendReqBtn.style.display = 'none';
  // Reset text/style
  DOM.friendReqBtn.innerHTML = `
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
      <circle cx="9" cy="7" r="4"/>
      <line x1="19" y1="8" x2="19" y2="14"/>
      <line x1="22" y1="11" x2="16" y2="11"/>
    </svg>
    Add Friend
  `;
  DOM.friendReqBtn.style.color = 'var(--green)';
  DOM.friendReqBtn.style.borderColor = 'rgba(61,224,160,0.3)';
}

</script>

</body>
</html>
